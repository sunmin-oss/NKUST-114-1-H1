@model AirQualityWeb.Models.HomeViewModel
@{
    ViewData["Title"] = "空氣品質監測資料";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5">
                <i class="bi bi-cloud-fog me-2"></i>空氣品質監測資料
            </h1>
            <p class="text-muted">全台空氣品質監測站即時資料瀏覽與分析</p>
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Info"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="bi bi-info-circle me-2"></i>@TempData["Info"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- 篩選與搜尋區 -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" asp-action="Index" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">測站</label>
                    <select name="site" class="form-select">
                        <option value="">全部測站</option>
                        @foreach (var site in Model.Sites)
                        {
                            <option value="@site" selected="@(site == Model.SelectedSite)">@site</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">測項</label>
                    <select name="item" class="form-select">
                        <option value="">全部測項</option>
                        @foreach (var item in Model.Items)
                        {
                            <option value="@item" selected="@(item == Model.SelectedItem)">@item</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">監測月份</label>
                    <select name="month" class="form-select">
                        <option value="">全部月份</option>
                        @foreach (var month in Model.Months)
                        {
                            <option value="@month" selected="@(month == Model.SelectedMonth)">@month</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">關鍵字搜尋</label>
                    <input type="text" name="search" class="form-control" placeholder="測站或測項名稱..." value="@Model.SearchKeyword">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> 篩選
                    </button>
                </div>
            </form>
            <div class="mt-3">
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-counterclockwise"></i> 清除篩選
                </a>
                <a href="@Url.Action("Map")" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-map"></i> 地圖視覺化
                </a>
                <a href="@Url.Action("ImportData")" class="btn btn-outline-primary btn-sm" onclick="return confirm('確定要從 JSON 匯入資料嗎? (已存在的資料不會被刪除)')">
                    <i class="bi bi-upload"></i> 匯入資料
                </a>
            </div>
        </div>
    </div>

    <!-- 資料統計 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle me-2"></i>
                共找到 <strong>@Model.TotalRecords</strong> 筆資料，
                目前顯示第 <strong>@Model.CurrentPage</strong> / <strong>@Model.TotalPages</strong> 頁
            </div>
        </div>
    </div>

    <!-- 資料表格 -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 5%">ID</th>
                            <th style="width: 12%">測站</th>
                            <th style="width: 15%">測項</th>
                            <th style="width: 15%">測項英文</th>
                            <th style="width: 8%">單位</th>
                            <th style="width: 10%">監測月份</th>
                            <th style="width: 10%">監測值</th>
                            <th style="width: 15%">建立時間</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Records.Count == 0)
                        {
                            <tr>
                                <td colspan="8" class="text-center text-muted py-5">
                                    <i class="bi bi-inbox display-1"></i>
                                    <p class="mt-3">查無資料</p>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var record in Model.Records)
                            {
                                <tr>
                                    <td>@record.Id</td>
                                    <td>
                                        <span class="badge bg-primary">@record.SiteId</span>
                                        <br><small>@record.SiteName</small>
                                    </td>
                                    <td>@record.ItemName</td>
                                    <td><small class="text-muted">@record.ItemEngName</small></td>
                                    <td>@record.ItemUnit</td>
                                    <td>
                                        <i class="bi bi-calendar3"></i> @record.MonitorMonth
                                    </td>
                                    <td>
                                        @if (record.Concentration.HasValue)
                                        {
                                            var value = record.Concentration.Value;
                                            var badgeClass = value < 12 ? "bg-success" : value < 20 ? "bg-warning" : value < 30 ? "bg-orange" : "bg-danger";
                                            <span class="badge @badgeClass">@value.ToString("F2")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td><small>@record.CreatedAt.ToString("yyyy-MM-dd HH:mm")</small></td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 分頁導航 -->
    @if (Model.TotalPages > 1)
    {
        <nav class="mt-4" aria-label="分頁導航">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { site = Model.SelectedSite, item = Model.SelectedItem, month = Model.SelectedMonth, search = Model.SearchKeyword, page = Model.CurrentPage - 1 })">
                        上一頁
                    </a>
                </li>

                @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                {
                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { site = Model.SelectedSite, item = Model.SelectedItem, month = Model.SelectedMonth, search = Model.SearchKeyword, page = i })">
                            @i
                        </a>
                    </li>
                }

                <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("Index", new { site = Model.SelectedSite, item = Model.SelectedItem, month = Model.SelectedMonth, search = Model.SearchKeyword, page = Model.CurrentPage + 1 })">
                        下一頁
                    </a>
                </li>
            </ul>
        </nav>
    }
</div>

@section Styles {
    <style>
        .bg-orange {
            background-color: #ff9800 !important;
        }
    </style>
}
